from django.shortcuts import render, redirect
from django.contrib.auth import login, authenticate
from django.contrib.auth.forms import UserCreationForm
from django.contrib.auth.decorators import login_required
from django.db.models import Count
from django.contrib import messages
from .models import TelegramUser, PollResponse
from .forms import RegisterForm # Need to create this

@login_required
def dashboard(request):
    try:
        telegram_user = request.user.telegram_user
        responses = PollResponse.objects.filter(telegram_user=telegram_user)
        
        # Aggregate data for charts
        data = responses.values('activity').annotate(count=Count('activity'))
        
        # Map activity codes to names
        activity_map = dict(PollResponse.ACTIVITY_CHOICES)
        chart_labels = []
        chart_data = []
        
        for entry in data:
            label = activity_map.get(entry['activity'], 'Unknown')
            chart_labels.append(label)
            chart_data.append(entry['count'])
            
        context = {
            'chart_labels': chart_labels,
            'chart_data': chart_data,
            'recent_responses': responses.order_by('-timestamp')[:10]
        }
        return render(request, 'core/dashboard.html', context)
        
    except TelegramUser.DoesNotExist:
        messages.warning(request, "Please link your Telegram account.")
        return redirect('link_telegram')

def register(request):
    if request.method == 'POST':
        form = RegisterForm(request.POST)
        if form.is_valid():
            user = form.save()
            chat_id = form.cleaned_data.get('telegram_chat_id')
            if chat_id:
                TelegramUser.objects.create(user=user, chat_id=chat_id)
            login(request, user)
            return redirect('dashboard')
    else:
        form = RegisterForm()
    return render(request, 'core/register.html', {'form': form})
